#!/bin/bash
clear
cd $HOME 
#########
# COLORS
#########

#colors
#colors
white="\033[1;37m"                                          ##
grey="\033[0;37m"                                           ##
purple="\033[1;35m"                                         ##
red="\033[1;31m"                                            ##
green="\033[1;32m"                                          ##
yellow="\033[1;33m"                                         ##
purple="\033[0;35m"                                         ##
cyan="\033[0;36m"                                           ##
cyan1="\033[1;36m"                                          ##
cafe="\033[0;33m"                                           ##
fiuscha="\033[0;35m"                                        ##
blue="\033[1;34m"                                           ##
l_red="\033[1;37;41m"                                       ##
nc="\033[0m"                                                ## 

arch=`uname -m`
ArNam=$(dpkg --print-architecture)
#spinner
spinner() {
        pid=$!
        spin='\|/-'
        i=0
        tput civis
        while kill -0 $pid 2>/dev/null
	do
                i=$(( (i+1) %4 ))
                printf "\r${cyan1}[${spin:$i:1}]${nc} ${cyan1} ${launch}"
                sleep .1
	done
        clear
        printf "\r\n${green}[âœ”]${nc} ${green} ${splashdown}";echo
        tput cnorm
}
function os () {
	cat /etc/os-release > /dev/null 2>&1
	if [ "$?" -eq "0" ]; then
		OS=DEBIAN 
		BIN="/usr/bin"
		main="/usr/share/shark"
	else
		OS=TERMUX
		BIN="${PREFIX}/bin"
		main="${PREFIX}/share/shark"
	fi
	echo -e "${green}[*]${white} Detected OS: ${OS}"
}

function git_clone() {
	launch="cloning shark";splashdown="shark cloned";echo
	[ -d "${main}" ] && rm -rf ${main} > /dev/null 2>&1
	(git clone https://github.com/404unkown/shark --quiet ${main} --depth=1) & spinner
}
function check_network() {
    echo -e "${green}[*]${white} Checking network connectivity..."
    
    # Multiple connection tests
    echo -e "${green}[*]${white} Testing connectivity to multiple endpoints..."
    
    success=false
    
    # Test 1: Ping Cloudflare DNS
    if ping -c 1 -W 2 1.1.1.1 &>/dev/null; then
        echo -e "${green}[âœ“]${white} Connection to Cloudflare OK"
        success=true
    fi
    
    # Test 2: Ping Google DNS
    if ping -c 1 -W 2 8.8.8.8 &>/dev/null; then
        echo -e "${green}[âœ“]${white} Connection to Google DNS OK"
        success=true
    fi
    
    # Test 3: Test HTTPS to Cloudflare
    if curl -s --connect-timeout 5 --max-time 10 https://cloudflare.com &>/dev/null; then
        echo -e "${green}[âœ“]${white} HTTPS to Cloudflare OK"
        success=true
    fi
    
    # Test 4: Test HTTPS to GitHub (for downloads)
    if curl -s --connect-timeout 5 --max-time 10 https://github.com &>/dev/null; then
        echo -e "${green}[âœ“]${white} HTTPS to GitHub OK"
        success=true
    fi
    
    if [ "$success" = true ]; then
        echo -e "${green}[âœ“]${white} Network connectivity verified"
        return 0
    else
        echo -e "${red}[âœ—]${white} Network connectivity issues detected!"
        echo -e "${yellow}[*]${white} Possible issues:"
        echo -e "  1. No internet connection"
        echo -e "  2. Firewall blocking connections"
        echo -e "  3. DNS issues"
        echo -e "  4. Proxy/VPN interference"
        echo -e ""
        echo -e "${yellow}[*]${white} Solutions:"
        echo -e "  1. Check WiFi/mobile data"
        echo -e "  2. Disable VPN/Proxy"
        echo -e "  3. Try: termux-change-repo (for Termux)"
        echo -e "  4. Run: pkg update (for Termux)"
        exit 1
    fi
}

function dependencies() {
    killall -q dpkg apt pkg &>/dev/null
    clear
    sleep 1
    
    echo -e "${green}[*]${white} Checking and installing dependencies..."
    
    # Termux specific setup
    if [ ${OS} != "DEBIAN" ]; then
        echo -e "${green}[*]${white} Setting up Termux environment..."
        
        # Update Termux packages
        launch="Updating Termux packages"; splashdown="Termux updated"; echo
        (pkg update -y && pkg upgrade -y) & spinner
        
        # Install essential Termux packages first
        echo -e "${green}[*]${white} Installing core packages..."
        for pkg in ncurses-utils wget gnupg nano vim; do
            if ! pkg list-installed | grep -q "$pkg"; then
                echo -e "${yellow}[*]${white} Installing $pkg..."
                pkg install "$pkg" -y &>/dev/null
            fi
        done
        
        # Main dependency installation
        launch="Installing main dependencies"; splashdown="Dependencies installed"; echo
        for i in php apache2 curl git wget jq unzip dialog proot sox ffmpeg python python-pip nodejs; do
            if ! command -v "$i" &>/dev/null && ! pkg list-installed | grep -q "$i"; then
                echo -e "${green}[+]${white} Installing: $i"
                pkg install "$i" -y &>/dev/null
                
                # Special handling for specific packages
                case "$i" in
                    "apache2")
                        # In Termux, httpd is used instead of apache2
                        pkg install httpd -y &>/dev/null
                        ;;
                    "php")
                        # Install PHP extensions
                        pkg install php-apache php-mysqli -y &>/dev/null 2>&1
                        ;;
                esac
            else
                echo -e "${cyan}[*]${white} Already installed: $i"
            fi
        done
        
        # Additional Termux packages
        echo -e "${green}[*]${white} Installing additional Termux packages..."
        for pkg in termux-api termux-services libandroid-support resolv-conf; do
            if ! pkg list-installed | grep -q "$pkg"; then
                pkg install "$pkg" -y &>/dev/null
            fi
        done
        
        # Install Python modules
        echo -e "${green}[*]${white} Installing Python modules..."
        pip install requests colorama &>/dev/null
        
    else
        # DEBIAN/Ubuntu setup
        launch="Updating system packages"; splashdown="System updated"; echo
        (sudo apt-get update -y && sudo apt-get upgrade -y) & spinner
        
        launch="Installing dependencies"; splashdown="Dependencies installed"; echo
        for i in apache2 php php-curl php-mysqli jq curl wget git unzip dialog sox ffmpeg python3 python3-pip; do
            if ! dpkg -l | grep -q "^ii.*$i"; then
                echo -e "${green}[+]${white} Installing: $i"
                sudo apt-get install "$i" -y &>/dev/null
            else
                echo -e "${cyan}[*]${white} Already installed: $i"
            fi
        done
        
        # Install Python modules for Debian
        pip3 install requests colorama &>/dev/null
    fi
    
    # Verify installations
    echo -e "\n${green}[*]${white} Verifying installations..."
    
    # Check PHP
    if command -v php &>/dev/null; then
        echo -e "${green}[âœ“]${white} PHP installed: $(php --version | head -1)"
    else
        echo -e "${red}[âœ—]${white} PHP installation failed"
    fi
    
    # Check curl
    if command -v curl &>/dev/null; then
        echo -e "${green}[âœ“]${white} curl installed"
    else
        echo -e "${red}[âœ—]${white} curl installation failed"
    fi
    
    # Check git
    if command -v git &>/dev/null; then
        echo -e "${green}[âœ“]${white} git installed: $(git --version)"
    else
        echo -e "${red}[âœ—]${white} git installation failed"
    fi
    
    # Check if all required commands are available
    missing=0
    for cmd in php curl git wget; do
        if ! command -v "$cmd" &>/dev/null; then
            echo -e "${red}[âœ—]${white} $cmd is missing"
            missing=$((missing + 1))
        fi
    done
    
    if [ $missing -eq 0 ]; then
        echo -e "${green}[+]${white} All dependencies installed successfully!"
    else
        echo -e "${yellow}[!]${white} $missing dependency(s) missing. Some features may not work."
        echo -e "${yellow}[*]${white} Try installing manually:"
        if [ ${OS} != "DEBIAN" ]; then
            echo -e "  pkg install php curl git wget apache2"
        else
            echo -e "  sudo apt install php curl git wget apache2"
        fi
    fi
    
    # Setup storage for Termux
    if [ ${OS} != "DEBIAN" ]; then
        echo -e "${green}[*]${white} Setting up Termux storage..."
        if [ ! -d ~/storage ]; then
            termux-setup-storage
            echo -e "${green}[+]${white} Termux storage permission granted"
        else
            echo -e "${cyan}[*]${white} Termux storage already set up"
        fi
    fi
}

function setup_cloudflare() {
    echo -e "${green}[*]${white} Setting up Cloudflare Tunnel..."
    
    # Check if already installed and working
    if [ -f ${BIN}/cloudflared ] && ${BIN}/cloudflared --version &>/dev/null; then
        echo -e "${green}[âœ“]${white} Cloudflared already installed and working"
        return 0
    fi
    
    # Remove old/broken installation
    rm -f ${BIN}/cloudflared cloudflared cloudflared-* 2>/dev/null
    
    # Determine correct architecture
    case "$arch" in
        *"aarch64"*|*"arm64"*)
            cloudd="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64"
            echo -e "${green}[*]${white} Architecture: ARM64"
            ;;
        *"armv7l"*|*"armv8l"*|*"arm"*)
            cloudd="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm"
            echo -e "${green}[*]${white} Architecture: ARM (32-bit)"
            ;;
        *"x86_64"*)
            cloudd="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
            echo -e "${green}[*]${white} Architecture: x86_64"
            ;;
        *"i686"*|*"i386"*)
            cloudd="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-386"
            echo -e "${green}[*]${white} Architecture: x86 (32-bit)"
            ;;
        *)
            echo -e "${yellow}[!]${white} Unknown architecture: $arch, trying ARM64"
            cloudd="https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-arm64"
            ;;
    esac
    
    echo -e "${green}[*]${white} Downloading Cloudflared..."
    
    # Download with retries
    for i in {1..3}; do
        launch="Download attempt $i/3"; splashdown="Download complete"; echo
        (wget --tries=2 --timeout=20 "$cloudd" -O cloudflared) & spinner
        
        if [ -f "cloudflared" ] && [ -s "cloudflared" ]; then
            echo -e "${green}[âœ“]${white} Download successful"
            break
        else
            echo -e "${yellow}[!]${white} Download failed, attempt $i/3"
            sleep 2
        fi
    done
    
    if [ ! -f "cloudflared" ] || [ ! -s "cloudflared" ]; then
        echo -e "${red}[âœ—]${white} Failed to download Cloudflared"
        echo -e "${yellow}[*]${white} Try manual installation:"
        
        if [ ${OS} != "DEBIAN" ]; then
            echo -e "  pkg install cloudflared"
        else
            echo -e "  wget -q https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64"
            echo -e "  chmod +x cloudflared"
            echo -e "  sudo mv cloudflared /usr/local/bin/"
        fi
        return 1
    fi
    
    # Make executable
    chmod +x cloudflared
    
    # Test the binary
    echo -e "${green}[*]${white} Testing Cloudflared binary..."
    if ./cloudflared --version &>/dev/null; then
        echo -e "${green}[âœ“]${white} Cloudflared binary is functional"
        
        # Install to bin directory
        if mv cloudflared ${BIN}/cloudflared; then
            echo -e "${green}[âœ“]${white} Installed to ${BIN}/cloudflared"
            
            # Final test
            if ${BIN}/cloudflared --version &>/dev/null; then
                echo -e "${green}[âœ“]${white} Cloudflared installation complete"
                return 0
            fi
        fi
    fi
    
    echo -e "${red}[âœ—]${white} Cloudflared binary failed to execute"
    
    # Try with termux-chroot for Termux
    if [ ${OS} != "DEBIAN" ] && command -v termux-chroot &>/dev/null; then
        echo -e "${yellow}[*]${white} Trying with termux-chroot..."
        if termux-chroot ./cloudflared --version &>/dev/null; then
            echo -e "${green}[âœ“]${white} Works with termux-chroot"
            mv cloudflared ${BIN}/cloudflared
            return 0
        fi
    fi
    
    rm -f cloudflared
    return 1
}

# â–¼â–¼â–¼ ADD THIS NEW FUNCTION HERE â–¼â–¼â–¼
function test_tunnel_services() {
    echo -e "\n${green}[*]${white} Testing tunnel services..."
    
    # Test if local server can start
    echo -e "${green}[*]${white} Testing PHP server..."
    timeout 5 php -S 127.0.0.1:9999 &>/dev/null &
    php_pid=$!
    sleep 2
    
    if kill -0 $php_pid 2>/dev/null; then
        echo -e "${green}[âœ“]${white} PHP server works on port 9999"
        kill $php_pid 2>/dev/null
    else
        echo -e "${red}[âœ—]${white} PHP server failed to start"
        echo -e "${yellow}[*]${white} Install PHP: pkg install php (Termux) or sudo apt install php (Debian)"
    fi
    
    # Test Cloudflared if installed
    if [ -f "${BIN}/cloudflared" ]; then
        echo -e "${green}[*]${white} Testing Cloudflared..."
        timeout 3 ${BIN}/cloudflared --version &>/dev/null
        if [ $? -eq 0 ]; then
            echo -e "${green}[âœ“]${white} Cloudflared binary works"
        else
            echo -e "${yellow}[!]${white} Cloudflared binary exists but may need termux-chroot"
        fi
    fi
    
    # Test ngrok if installed
    if [ -f "${BIN}/ngrok" ]; then
        echo -e "${green}[*]${white} Testing Ngrok..."
        if [ -f "$HOME/.ngrok2/ngrok.yml" ]; then
            echo -e "${green}[âœ“]${white} Ngrok has authtoken configured"
        else
            echo -e "${yellow}[!]${white} Ngrok needs authtoken: ./ngrok authtoken YOUR_TOKEN"
        fi
    fi
    
    echo -e "${green}[*]${white} Tunnel services check complete"
}
# â–²â–²â–² END OF NEW FUNCTION â–²â–²â–²

function setup_ngrok() {
	if [ ! -f  "${BIN}/ngrok" ]; then
		if [[ ("$arch" == *'arm'*) || ("$arch" == *'Android'*) ]]; then
			ngrok_url="https://github.com/E343IO/stuff/raw/main/ngrok-2in1.zip"
		elif [[ "$arch" == *'aarch64'* ]]; then
                         if [[ "$ArNam" == *'amd64'* ]]; then
                              ngrok_url="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip"
                        else
                              ngrok_url="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-arm64.zip"
                         fi
		elif [[ "$arch" == *'x86_64'* ]]; then
		        if [[ "$ArNam" == *'amd64'* ]]; then 
                         ngrok_url="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-amd64.zip"
                        else
                         ngrok_url="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-arm64.zip"
                        fi
                else
                        ngrok_url="https://bin.equinox.io/c/4VmDzA7iaHb/ngrok-stable-linux-386.zip"
	        fi
		launch="Installing ngrok"; splashdown="Ngrok installed"; echo
		(wget --quiet $ngrok_url -O ngrok.zip)& spinner
		unzip -q ngrok.zip && rm -rf ngrok.zip && chmod +x ngrok && mv ngrok $BIN
        else
              echo ""
        fi
}
function final_touchup() {
	for i in shark; do
		chmod +x ${main}/${i}
		mv ${main}/${i} ${BIN}
		launch="setting up files"; splashdown="done";echo
		(cd ${main} && 7z x file &>/dev/null)& spinner

	done
if [ ${OS} != "DEBIAN" ]; then
	clear
	dialog --title "Â© SHARK 2022-2023" --inputbox  "*Ngrok Authtoken verification \nEnter your authtoken without './' :" 0 0 2> authtk
        mv authtk ${BIN}
        chmod +x ${BIN}/authtk
        sleep 2
        clear
        sleep 2
        authtk &>/dev/null
        export user=$HOME
        mv ${BIN}/authtk ${BIN}/authtoken
        chmod +x ${BIN}/authtoken                                                                        
        #printf ${yellow}"Full exiting....\nJust Reopen your termux after exit. \n"
        sleep 1       
        printf "\n${green}>>${white} simply run : shark \n\n ${nc}"
else 
        clear
        dialog --title "Â© SHARK 2022-2023" --inputbox  "*Ngrok Authtoken verification \nEnter your authtoken without './' :" 0 0 2> authtk
        mv authtk ${BIN}
        chmod +x ${BIN}/authtk
        sleep 2
        clear
        authtk &>/dev/null
        printf "\n${green}>>${white} simply run : shark \n\n ${nc}"
fi
}
printf "${yellow}Please Wait.\n\n[!] Don't terminate this task.\n"
os
check_network
clear
printf "${green}[1/6] Setting up dependencies...\n"
sleep 2
dependencies
clear
printf "${green}[2/6] Downloading Shark...\n"
sleep 1
git_clone
clear
printf "${green}[3/6] Setting up Cloudflare Tunnel...\n"
sleep 1
setup_cloudflare
clear
printf "${green}[4/6] Setting up Ngrok...\n"
sleep 1
setup_ngrok
clear
printf "${green}[5/6] Testing tunnel services...\n"
sleep 1
test_tunnel_services
clear
printf "${green}[6/6] Finalizing installation...\n"
sleep 1
final_touchup

# Installation complete message
echo -e "\n${cyan}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${nc}"
echo -e "${green}âœ…  SHARK Installation Complete!${white}"
echo -e "${cyan}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${nc}"
echo -e "${yellow}ğŸš€ To start Shark:${white}"
if [ ${OS} != "DEBIAN" ]; then
    echo -e "   ${green}shark${white}"
else
    echo -e "   ${green}sudo shark${white}"
fi

echo -e "\n${yellow}ğŸŒ Tunnel Options:${white}"
echo -e "   ${green}A${white} - Ngrok (Recommended, more reliable)"
echo -e "   ${green}B${white} - Cloudflare (May have 'server busy' issues)"
echo -e "   ${green}D${white} - Localhost (For testing on same network)"

echo -e "\n${yellow}âš ï¸  If Cloudflare says 'server busy':${white}"
echo -e "   1. Wait 5-10 minutes and try again"
echo -e "   2. Use Ngrok option instead"
echo -e "   3. Get ngrok authtoken from: https://dashboard.ngrok.com"

if [ ${OS} != "DEBIAN" ]; then
    echo -e "\n${yellow}ğŸ“± Termux Tips:${white}"
    echo -e "   Run: ${green}termux-setup-storage${white}"
    echo -e "   Run: ${green}pkg update && pkg upgrade${white}"
    echo -e "   Allow background operation in Android settings"
fi

echo -e "\n${cyan}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${nc}"
echo -e "${red}âš ï¸  LEGAL WARNING:${white} Only use for educational purposes"
echo -e "${red}   Phishing without permission is ILLEGAL${white}"
echo -e "${cyan}â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•${nc}\n"

#########################################
#       DON'T TRY TO COPY ğŸ˜‚ğŸ˜‚          #
#   JUST LEARNING KEEP SUPPORTING       #
#             THANKYOU                  #
#        M r. D e r e K   (Contributor) #
#     B h a v i k   O z a (Publisher)   #  
#    A s h i s h  S i n g h (Author)    #
#########################################
_